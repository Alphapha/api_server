# 设备序列号查询API文档

## 1. 项目概述

本项目实现了一个基于Flask的RESTful API服务，用于查询设备的维保信息。目前支持深信服(Sangfor)和华为(Huawei)设备的序列号查询，并预留了联想(Lenovo)的查询接口。

## 2. API端点

### 2.1 深信服设备查询
- **端点**: `/sn_query/sangfor`
- **方法**: GET, POST
- **参数**: `sn` (设备序列号)
- **返回**: 设备维保信息的JSON响应

### 2.2 华为设备查询（已实现）
- **端点**: `/sn_query/huawei`
- **方法**: GET, POST
- **参数**: `sn` (设备序列号)
- **返回**: 设备维保信息的JSON响应，包含描述字段

### 2.3 联想设备查询（预占位）
- **端点**: `/sn_query/lenovo`
- **方法**: GET, POST
- **参数**: `sn` (设备序列号)
- **返回**: 空数据的JSON响应

## 3. 实现逻辑

### 3.1 核心架构

项目采用分层架构设计：

1. **会话管理层**：负责深信服BBS论坛的登录和会话维护
2. **服务查询层**：负责发送设备序列号和验证码进行维保信息查询
3. **API接口层**：提供RESTful接口，处理HTTP请求和响应
4. **多厂商适配层**：预留多厂商支持架构

### 3.2 会话管理

- **会话持久化**：使用pickle将登录会话保存到本地文件，避免频繁登录
- **会话验证**：定期验证会话有效性，无效时自动重新登录
- **重试机制**：网络请求失败时自动重试，提高可靠性

### 3.3 服务查询流程

1. **获取有效会话**：从文件加载或重新登录获取
2. **访问服务查询页面**：获取初始页面内容
3. **动态获取验证码**：
   - 调用验证码更新接口获取idhash
   - 下载验证码图片
   - 使用外部OCR API识别验证码
4. **发送查询请求**：携带设备序列号和验证码发送POST请求
5. **解析响应结果**：将原始响应转换为人类可读格式

### 3.4 错误处理

- **网络错误**：自动重试机制
- **验证码错误**：多次尝试不同验证码
- **会话过期**：自动重新登录
- **参数错误**：返回友好的错误信息

## 4. 响应解析规则

### 4.1 原始响应格式

深信服BBS返回的原始响应格式如下：

```json
{
  "success": 1,
  "data": [
    {
      "rnum": "WAZEAE0044",
      "rid": "97FE0E0A",
      "pdName": "AC-1000-B1100",
      "cti_channame": "上海联合电子科技有限公司",
      "cit_chanphone": "021-60959881",
      "cti_day2_800": "2027-04-11",
      "cti_day2_up": "2027-04-11",
      "cit_day2_rb": "2027-04-11"
    }
  ]
}
```

### 4.2 解析映射规则

#### 4.2.1 深信服设备解析映射

API将深信服设备的原始响应映射为人类可读的字段名：

| 原始字段名 | 映射后的字段名 | 说明 |
|----------|-------------|------|
| rnum | 序列号 | 设备的唯一序列号 |
| rid | 网关id | 设备的网关ID |
| pdName | 设备型号 | 设备的型号信息 |
| cti_channame | 服务商名称 | 负责维保的服务商名称 |
| cit_chanphone | 服务电话 | 服务商的联系电话 |
| cti_day2_800 | 网络远程支持有效期 | 远程技术支持的有效期 |
| cti_day2_up | 同等功能软件升级有效期 | 软件升级服务的有效期 |
| cit_day2_rb | 硬件维保有效期 | 硬件设备的维保有效期 |

#### 4.2.2 华为设备解析映射

API将华为设备的原始响应映射为人类可读的字段名：

| 原始字段名 | 映射后的字段名 | 说明 |
|----------|-------------|------|
| barcode | 序列号 | 设备的唯一序列号 |
| snModel | 设备型号 | 设备的型号信息 |
| servicePackage | 服务套餐 | 设备的服务套餐类型 |
| startDate | 开始日期 | 维保服务的开始日期 |
| endDate | 结束日期 | 维保服务的结束日期 |
| vybOrgStutas | 状态 | 维保服务的状态 |
| country | 国家/地区 | 设备所在国家或地区 |
| warrantyArea | 保修区域 | 设备的保修区域 |
| itemDescription | 描述 | 设备的详细描述信息 |

### 4.3 解析后响应格式

解析后的响应格式如下：

**深信服设备响应示例：**

```json
{
  "success": 1,
  "data": [
    {
      "序列号": "WAZEAE0044",
      "网关id": "97FE0E0A",
      "设备型号": "AC-1000-B1100",
      "服务商名称": "上海联合电子科技有限公司",
      "服务电话": "021-60959881",
      "网络远程支持有效期": "2027-04-11",
      "同等功能软件升级有效期": "2027-04-11",
      "硬件维保有效期": "2027-04-11"
    }
  ]
}
```

**华为设备响应示例：**

```json
{
  "success": 1,
  "data": [
    {
      "序列号": "1023A7333670",
      "设备型号": "S5731S-H24T4XC-A",
      "服务套餐": "15天更换保修",
      "开始日期": "2024/02/08",
      "结束日期": "2025/02/07",
      "状态": "Terminated",
      "国家/地区": "China",
      "保修区域": "中国",
      "描述": "S5731S-H24T4XC 组合配置(24个10/100/1000BASE-T以太网端口,4个万兆SFP+,单子卡槽位,含1个交流电源)"
    }
  ]
}
```

## 5. 技术实现细节

### 5.1 会话管理实现

- **会话保存**: 使用`pickle`模块将`requests.Session`对象序列化到文件
- **会话验证**: 访问需要登录的页面验证会话有效性
- **自动登录**: 当会话失效时自动执行登录流程

### 5.2 验证码处理

- **动态获取**: 通过调用验证码更新接口获取最新验证码
- **OCR识别**: 使用外部OCR API (`http://char1es.cn:8888/reg`)识别验证码
- **重试机制**: 验证码识别失败时自动重试

### 5.3 多厂商支持架构

- **路由设计**: 使用`/sn_query/{厂商英文名}`的路由格式
- **扩展性**: 每个厂商可以实现独立的查询逻辑
- **统一接口**: 保持所有厂商接口的参数和返回格式一致

## 6. 部署与配置

### 6.1 依赖项

- Python 3.6+
- Flask
- requests
- beautifulsoup4
- python-dotenv
- pickle (标准库)
- logging (标准库)

### 6.2 配置项

- **登录信息**: 在`.env`文件中配置各厂商的账号和密码MD5
- **会话文件**: 默认使用`session.pkl`保存会话
- **日志配置**: 同时输出到文件和控制台

### 6.3 .env文件配置

为了提高安全性，所有厂商的账号密码都存储在`.env`文件中，格式如下：

```env
# 深信服(Sangfor) BBS账号配置
SANGFOR_USERNAME=你的账号
SANGFOR_PASSWORD=你的密码MD5

# 华为(Huawei)账号配置（预留）
# HUAWEI_USERNAME=
# HUAWEI_PASSWORD=

# 联想(Lenovo)账号配置（预留）
# LENOVO_USERNAME=
# LENOVO_PASSWORD=
```

**注意**: `.env`文件包含敏感信息，应确保其权限设置正确，且不被提交到版本控制系统。

### 6.4 启动服务

```bash
python service_query_api.py
```

服务默认运行在`http://0.0.0.0:9876`

## 7. 扩展指南

### 7.1 添加新厂商支持

1. **添加路由**: 在`service_query_api.py`中添加新的路由函数
2. **实现查询逻辑**: 为新厂商实现专门的查询逻辑
3. **更新文档**: 在本文档中添加新厂商的API信息

### 7.2 优化建议

1. **缓存机制**: 为频繁查询的序列号添加缓存
2. **并发处理**: 考虑使用异步处理提高并发能力
3. **监控系统**: 添加API调用监控和告警
4. **测试覆盖**: 增加单元测试和集成测试

## 8. 示例请求与响应

### 8.1 GET请求示例

**深信服设备查询：**

```bash
curl "http://localhost:9876/sn_query/sangfor?sn=61902B45"
```

**华为设备查询：**

```bash
curl "http://localhost:9876/sn_query/huawei?sn=1023A7333670"
```

### 8.2 POST请求示例

**深信服设备查询：**

```bash
curl -X POST -H "Content-Type: application/json" -d '{"sn": "61902B45"}' "http://localhost:9876/sn_query/sangfor"
```

**华为设备查询：**

```bash
curl -X POST -H "Content-Type: application/json" -d '{"sn": "1023A7333670"}' "http://localhost:9876/sn_query/huawei"
```

### 8.3 成功响应示例

```json
{
  "success": 1,
  "data": [
    {
      "序列号": "WAZCCG0292",
      "网关id": "61902B45",
      "设备型号": "AC-1000-B1300",
      "服务商名称": "上海联合电子科技有限公司",
      "服务电话": "021-60959881",
      "网络远程支持有效期": "2025-08-10",
      "同等功能软件升级有效期": "2025-08-10",
      "硬件维保有效期": "2025-08-10"
    }
  ]
}
```

### 8.4 错误响应示例

```json
{
  "success": 0,
  "message": "设备序列号不能为空"
}
```

## 9. 故障排查

### 9.1 常见错误

| 错误信息 | 可能原因 | 解决方案 |
|---------|---------|--------|
| 验证码错误 | OCR识别失败 | 检查网络连接，增加重试次数 |
| 会话过期 | 登录状态失效 | 检查账号密码是否正确，清除旧会话文件 |
| 网络错误 | 网络连接问题 | 检查网络连接，增加超时时间 |
| 参数错误 | 序列号格式不正确 | 检查序列号是否正确输入 |

### 9.2 日志查看

API服务的日志同时输出到控制台和`service_query_api.log`文件，可以通过查看日志了解详细的执行过程和错误信息。

## 10. 结语

本API服务提供了一个统一的设备维保信息查询接口，目前已实现深信服和华为设备的查询功能，并为后续扩展联想等其他厂商的查询功能预留了接口。通过会话管理、验证码处理和错误重试等机制，提高了API的可靠性和稳定性。

华为设备查询接口已完整实现，支持自动处理验证码、解析维保信息并返回包含设备描述的详细信息。深信服设备查询接口支持完整的会话管理和验证码处理，确保查询的可靠性。