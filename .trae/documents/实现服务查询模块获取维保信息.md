# 服务查询模块实现计划

## 正确流程分析
1. **打开入口页面**：`https://bbs.sangfor.com.cn/plugin.php?id=service:query`
2. **验证码处理**：
   - 获取验证码更新接口：`/misc.php?mod=seccode&action=update&idhash={idhash}&{random}&modid=plugin::service`
   - 从响应中提取验证码图片URL：`misc.php?mod=seccode&update={random}&idhash={idhash}`
   - 验证码参数：`seccodeverify={验证码}`（如 `ey2t`）
3. **构建查询请求**：
   - URL: `plugin.php?id=service:query&op=doquery&type=svrstate&seccodeverify={验证码}&seccodehash={idhash}&seccodemodid=plugin::service&svrid={设备序列号}`
   - 请求体: `ajaxdata=json`
   - 头部: `X-Requested-With: XMLHttpRequest`
4. **处理响应**：解析JSON格式的维保信息

## 实现步骤

### 1. 创建优化版服务查询模块
- 新建 `service_query_optimized.py` 文件
- 集成session管理功能
- 实现完整的查询流程

### 2. 验证码处理
- **提取idhash**：从页面或验证码更新响应中提取
- **获取验证码图片**：使用正确的URL格式 `misc.php?mod=seccode&update={random}&idhash={idhash}`
- **OCR识别**：使用pytesseract识别验证码
- **验证结果**：确保识别结果符合要求

### 3. 查询请求构建
- **完整URL**：包含所有必要参数
- **请求头**：添加 `X-Requested-With: XMLHttpRequest`
- **请求体**：设置为 `ajaxdata=json`
- **参数验证**：确保所有参数正确设置

### 4. 响应处理
- **JSON解析**：正确解析返回的JSON数据
- **信息提取**：提取设备维保详细信息（如 `WAZCCG0292`、`AC-1000-B1300`、维保日期等）
- **错误处理**：处理查询失败情况

### 5. 测试验证
- 测试完整查询流程
- 验证不同设备序列号
- 确保响应解析正确

## 关键技术点
- 准确的验证码识别
- 正确的AJAX请求构建
- 有效的JSON响应解析
- 健壮的错误处理
- 清晰的日志记录